# 3 计算机的机器级表示
当用高级语言编程时，机器屏蔽了程序机器级的实现。现代的优化编译器能等同一个熟练的汇编语言程序员手写，而且**使用高级语言编写的程序可以在很多不同的机器上编译和执行，汇编代码则与特定的机器密切相关。**
为了理解编译器的优化能力 分析代码中隐含的低效率，我们还是需要花时间学习机器代码。

计算机工业已经完成从32位到64位机器的过渡，32位机器只能使用4GB（2的32次方字节），当前的64位机器能够使用多达16EB(2的64次方字节)
### 3.1 历史观点
  Intel的处理器俗称x86，不断成长发展。近年来，出现了如AMD等竞争厂商。
如下是x86微处理器的晶体管数量与年份的图，每年大约以37%的速率增加。
![hello.c的ASCII文本表示](1.jpg)


### 3.2 程序编码
当我们启动linux上的gcc来编译一个C程序(两个.c文件)时，实际上gcc命令调用了一整套程序将源代码转化成可执行代码。
分为四个阶段：
- **预处理**   插入所有头文件，并拓展所有用#define申明的指定宏。
- **编译**     编译过程就是把预处理完的文件进行一系列词法分析，语法分析，语义分析及优化后生成相应的汇编代码文件(.s)
- **汇编**     将汇编代码文件翻译成机器语言指令，打包成可重定位目标二进制程序。(.o)
- **链接**     编译和汇编后得到的是 .o 的二进制文件，还没全局值的地址不能独立运行。链接会将前面编译好的.o文件、系统库的.o文件和库文件彼此相连接，把某个目标文件中引用的符号同另一个文件中的定义链接起来，将所有编译好的单元组成一个可执行文件。
 ![编译系统](2.jpg)
#### 3.2.1 机器级代码
对于机器级编程，有两种抽象尤为重要。
1.由**指令集体系结构(ISA)** 来定义机器级程序的格式和行为，它定义了处理器的状态，指令格式及每条指令对状态的影响。大多数的ISA，将程序的行为描述成好像每条指令是顺序执行的。虽然处理器并发地执行许多指令，但三可以采取措施保证整体行为与ISA指定的顺序执行行为完全一致。





#### 3.2.2 系统的硬件组成



### 1.3 了解编译系统如何工作是大有益处的
- 优化程序性能
- 理解链接时出现的错误
- 避免安全漏洞

### 1.4 处理器读并解释存储在内存中的指令
.c源文件翻译成.o的可执行文件后可以在命令行运行
#### 1.4.1 系统的硬件组成
 ![系统硬件组成](3.jpg)
- **总线**  贯穿系统的电子管道，携带信息字节在各个部件间传递。字中字节数是一个基本的系统参数，32位字长为4字节，64位字长为8字节。
- **I/O设备** 输入输出设备，如键鼠，磁盘。每个I/O设备通过控制器或者适配器与I/O总线相连。控制器为主印制电路板上的芯片组，适配器是主板插槽上的卡，它们都能在总线和设备间传递信息。
- **主存**  一个临时存储设备，是由一组*动态随机存取存储芯片(DRAM)*组成。组成程序的每条机器指令都由不同数量的字节构成，如在运行linux的x86-64上，int需要4个字节，long和double需要8个字节。
- **处理器** 中央处理单元(CPU)，是解释或执行存储在主存中指令的引擎。处理器的核心是大小为一个字的程序计数器(PC)。PC始终指向主存中的某条机器语言指令。处理器不断执行PC指向的指令，然后更新PC使其指向下一条指令。
#### 1.4.2 运行hello程序
首先shell程序会将输入字符逐一读入寄存器，存放至内存。然后执行一系列指令来加载可执行的hello文件，将其中的代码和数据从磁盘复制到主存。到主存后处理器执行main程序中的机器语言指令，然后从主存再到寄存器再到显示器显示。
 ![运行hello程序](4.jpg)

### 1.5 高速缓存至关重要
**系统花费大量时间把信息从一个地方移到另一个地方**
一开始程序的机器指令存放在磁盘，程序加载时被复制到主存；处理器运行程序时，指令从主存复制到处理器。然后处理完以后给到显示设备。这些复制就是开销，减慢了程序“真正”的工作。
高速缓存(cache)可以作为暂时的集结区来存放处理器近期会需要的信息。
一个典型的高速缓存存储器使用一种叫做 ***静态随机访问存储器(SRAM)*** 的硬件技术实现。通过让经常访问的数据放在高速缓存中来使大部分内存操作更加快速。

### 1.6 存储设备形成层次结构
存储器的层次结构如图所示，将上一层的存储器作为低一层存储器的高速缓存。
 ![存储器层次结构](5.jpg)

### 1.7 操作系统管理硬件
操作系统相当于是在应用程序和硬件之间插入的一层负责交互的软件，所有应用程序对硬件的操作必须通过操作系统。
操作系统既能向程序提供一致的机制来控制复杂又不相同的硬件，也能防止硬件被失控的应用程序滥用。
 ![存储器层次结构](6.jpg)
操作系统通过进程、虚拟内存和文件来实现上述的功能。
#### 1.7.1 进程
进程是操作系统对一个正在运行的程序的一种抽象。一个系统上可以同时运行多个进程。传统系统同一时刻只能执行一个程序，但是先进的多核处理器能同时执行多个程序。CPU通过进程间的切换执行多个进程。
操作系统需要追踪进程运行所需的所有状态信息(上下文，比如PC和寄存器文件的当前值和主存内容)。任意时刻，单处理器系统都只能执行一个进程的代码。当操作系统把控制权从当前进程转到另一个新进程，就会进行上下文切换。保存当前进程的上下文，恢复新进程的上下文，将控制权传递到新进程。
一个进程到另一个进程的转换是操作系统内核管理的，内核是系统管理全部进程所用代码和数据结构的集合。
 ![存储器层次结构](7.jpg)
#### 1.7.2 线程
 在现代系统中，一个进程由多个线程的执行单元组成，每个线程运行在进程的上下文，共享同样的代码和全局数据。多线程之间更容易共享数据，当有多个处理器时，多线程比进程更加高效。
#### 1.7.3 虚拟内存
虚拟内存是一个抽象的概念，它为每个进程提供一个一致的内存，让每个进程认为在独占使用主存。
Linux进程的虚拟地址空间如图所示
 ![存储器层次结构](8.jpg)
从下至上分别是：
- **程序代码和数据**       可执行目标文件初始化后形成代码和数码区。
- **堆** 代码和数据区在进程一开始时就指定了大小，堆则是在运行时动态地扩展和收缩。
- **共享库** 地址的中间部分是一块存放像C标准库和数学库的代码和数据。
- **栈**  位于用户虚拟地址空间顶部的用户栈，编译器用它实现函数的调用。在程序期间函数调用时，栈增长；从函数返回时，栈会收缩。
- **内核虚拟内存**  地址顶部空间是为内核保留的。不允许应用程序读写这个区域的内容，必须调用内核来执行操作。
#### 1.7.4 文件
文件就是字节序列。每个I/O设备，包括键鼠、显示器，甚至网络都可以视为文件。系统所有的输入输出通过Unix I/O的系统调用使用读写文件实现。

### 1.8 系统之间利用网络通信
现代系统经常通过网络和其他系统连接到一起，从一台主机复制信息到另一台主机已是计算机系统最重要的用途之一。
### 1.9 重要主题
#### 1.9.1 Amdahl定律
当我们对系统的某个部分加速时，其对系统整体性能的影响取决于该部分的重要性和加速程度。
- 想要显著加速整个系统，必须提升全系统中相当大的部分的速度。
#### 1.9.2 并发和并行
**1. 线程级并发**
在以前即使处理器在多个任务间切换，大多数实际的计算也是由一个处理器来完成，称为单处理器系统。我们可以构建一个由单操作系统内核控制的多处理器组成的系统来得到一个多处理器系统。多核处理器是将多个CPU集成到一个集成电路芯片。如图所示，4个CPU核每个都有自己的L1和L2的高速缓存，同时它们共享更高层的缓存以及到主存的接口。
 ![存储器层次结构](9.jpg)
**2. 指令级并发**
在较低的抽象层次上，现代处理器可以同时执行多条指令的属性称为指令级并行。如果处理器可以达到比一个周期一条指令更快的执行速率，就称为**超标量处理器**。程序员可以通过超标量处理器的高级模型来写出拥有更高程度并行的程序。
**3. 单指令、多数据并行**
在最低的层次，许多现代处理器拥有特殊的硬件允许一条指令产生多个可以并行的操作，这种方式称为单指令、多数据，即SIMD并行。
####1.9.3 计算机系统中抽象的重要性
抽象的使用是计算机科学中最为重要的概念之一。例如为一组函数规定一个简单的应用程序接口(API)就是一个很好的习惯。如下图就是计算机系统中的几个抽象：
 ![存储器层次结构](10.jpg)
### 1.10 小结
 计算机系统是由硬件和系统软件组成，共同协作以运行应用程序。计算机内部的信息被表示为一组组的位，它们依据上下文有不同的解释方式。程序被其他程序翻译成不同形式，开始是ASCII文本，然后被编译器和链接器翻译成二进制可执行文件。
 处理器读取并解释存放在主存里的二进制指令。因为计算机花费了大量时间在内存、I/O设备和CPU寄存器之间复制数据，所以将系统中的存储设备划分成层次结构，更高层的更快但是单价也更贵。
 操作系统内核是应用程序和硬件之间的媒介。操作系统提供三个基本的抽象：
   1. 文件是对I/O设备的抽象
   2. 虚拟内存是对主存和磁盘的抽象
   3. 进程是处理器、主存和I/O设备的抽象
   
网络提供了计算机系统之间的通信，是一种特殊的I/O设备。